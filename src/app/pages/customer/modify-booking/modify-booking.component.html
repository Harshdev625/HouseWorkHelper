<div class="modify-booking-container">
  <header class="header">
    <button class="back-btn" (click)="back()">&larr; Back</button>
    <h1>Modify Booking</h1>
    <div class="header-actions">
      <button class="cancel-btn" (click)="openCancelModal()" *ngIf="booking?.status !== 'COMPLETED' && booking?.status !== 'CANCELLED_BY_CUSTOMER'">
        Cancel Booking
      </button>
      <button class="confirm-btn" (click)="confirmChanges()" [disabled]="!hasChanges || saving" *ngIf="booking?.status !== 'COMPLETED' && booking?.status !== 'CANCELLED_BY_CUSTOMER'">
        {{ saving ? 'Saving...' : 'Confirm Changes' }}
      </button>
    </div>
  </header>

  <div class="loading" *ngIf="loading">Loading...</div>
  <div class="error" *ngIf="error">{{ error }}</div>

  <div class="content" *ngIf="!loading && !error && booking">
    <div class="main-section">
      <!-- Expert Card -->
      <div class="edit-section">
        <div class="section-header">
          <h2>Service Expert</h2>
          <button class="edit-icon-btn" (click)="openEditExpert()" *ngIf="booking.status !== 'COMPLETED' && booking.status !== 'CANCELLED_BY_CUSTOMER'">✏️</button>
        </div>
        <div class="expert-card" *ngIf="expert">
          <div class="expert-info">
            <strong>{{ expert.fullName }}</strong>
            <span class="verified-badge">✓ Verified</span>
          </div>
          <p>Rating: ⭐ {{ expert.rating }}</p>
          <p>Experience: {{ expert.experience }}</p>
          <p>Skills: {{ expert.skills.join(', ') }}</p>
        </div>
        <div *ngIf="!expert">
          <p>No expert assigned yet</p>
        </div>
      </div>

      <!-- Service Type -->
      <div class="edit-section">
        <div class="section-header">
          <h2>Service Type</h2>
        </div>
        <div class="service-info">
          <strong>{{ service?.name }}</strong>
          <p>{{ service?.description }}</p>
        </div>
      </div>

      <!-- Schedule Details -->
      <div class="edit-section">
        <div class="section-header">
          <h2>Schedule Details</h2>
          <button class="edit-icon-btn" (click)="openEditSchedule()" *ngIf="booking.status !== 'COMPLETED' && booking.status !== 'CANCELLED_BY_CUSTOMER'">✏️</button>
        </div>
        <div class="schedule-info">
          <p><strong>Frequency:</strong> {{ frequency }}</p>
          <p><strong>Start Date:</strong> {{ formatDate(booking.scheduledStartTime) }}</p>
          <p><strong>Time Slot:</strong> {{ formatTime(booking.scheduledStartTime) }}</p>
          <p><strong>Duration:</strong> {{ booking.durationMinutes }} minutes</p>
        </div>
      </div>

      <!-- Service Address -->
      <div class="edit-section">
        <div class="section-header">
          <h2>Service Address</h2>
          <button class="edit-icon-btn" (click)="openEditAddress()" *ngIf="booking.status !== 'COMPLETED' && booking.status !== 'CANCELLED_BY_CUSTOMER'">✏️</button>
        </div>
        <div class="address-info" *ngIf="address">
          <p><strong>{{ address.label }}</strong></p>
          <p>{{ address.line1 }}</p>
          <p *ngIf="address.line2">{{ address.line2 }}</p>
          <p>{{ address.city }}, {{ address.state }} - {{ address.postalCode }}</p>
        </div>
      </div>
    </div>

    <!-- Price Summary -->
    <div class="summary-section">
      <h2>Price Summary</h2>
      
      <div class="price-before" *ngIf="!hasChanges">
        <div class="price-row">
          <span>Base Amount</span>
          <span>₹{{ baseAmount }}</span>
        </div>
        <div class="price-row">
          <span>Amount Paid</span>
          <span class="paid">₹{{ amountPaid }}</span>
        </div>
        <div class="price-row">
          <span>Subtotal</span>
          <span>₹{{ subtotal }}</span>
        </div>
        <div class="price-row">
          <span>GST (18%)</span>
          <span>₹{{ gst }}</span>
        </div>
        <div class="price-row total">
          <span>Total Amount</span>
          <span>₹{{ totalAmount }}</span>
        </div>
      </div>

      <div class="price-after" *ngIf="hasChanges">
        <h3>After Changes:</h3>
        <div class="price-row">
          <span>Service Amount</span>
          <span>₹{{ newServiceAmount }}</span>
        </div>
        <div class="price-row">
          <span>Amount Paid</span>
          <span class="paid">₹{{ amountPaid }}</span>
        </div>
        <div class="price-row">
          <span>Subtotal</span>
          <span>₹{{ newSubtotal }}</span>
        </div>
        <div class="price-row">
          <span>GST (18%)</span>
          <span>₹{{ newGst }}</span>
        </div>
        <div class="price-row total">
          <span>Amount to Pay</span>
          <span class="highlight">₹{{ amountToPay }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Expert Modal -->
  <div class="modal-overlay" *ngIf="showEditExpertModal" (click)="closeEditExpert()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Select Expert</h2>
        <button class="close-btn" (click)="closeEditExpert()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" [(ngModel)]="expertSearch" placeholder="Search experts..." class="search-input">
        <div class="expert-list">
          <div class="expert-item" *ngFor="let exp of experts" (click)="selectExpert(exp.id)">
            <div class="expert-info">
              <strong>{{ exp.fullName }}</strong>
              <span class="verified-badge">✓ Verified</span>
            </div>
            <p>Rating: ⭐ {{ exp.rating }} ({{ exp.totalJobs }} jobs)</p>
            <p>Experience: {{ exp.experience }}</p>
            <p>Skills: {{ exp.skills.join(', ') }}</p>
            <p>Languages: {{ exp.languages?.join(', ') }}</p>
            <p>Rate: ₹{{ service?.hourlyRateInr }}/hr</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Schedule Modal -->
  <div class="modal-overlay" *ngIf="showEditScheduleModal" (click)="closeEditSchedule()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Edit Schedule</h2>
        <button class="close-btn" (click)="closeEditSchedule()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Frequency</label>
          <select [(ngModel)]="frequency" class="form-control">
            <option value="ONCE">Once</option>
          </select>
        </div>
        <div class="form-group">
          <label>Date</label>
          <select [(ngModel)]="selectedDate" class="form-control">
            <option *ngFor="let date of dateOptions" [value]="date">{{ date }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Time Slot</label>
          <select [(ngModel)]="selectedTimeSlot" class="form-control">
            <option *ngFor="let slot of timeSlots" [value]="slot">{{ slot }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Duration (minutes)</label>
          <input type="number" [(ngModel)]="durationMinutes" class="form-control" min="30" step="30">
        </div>
        <button class="save-btn" (click)="saveSchedule()">Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Address Modal -->
  <div class="modal-overlay" *ngIf="showEditAddressModal" (click)="closeEditAddress()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Select Address</h2>
        <button class="close-btn" (click)="closeEditAddress()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="address-list" *ngIf="!showAddAddress">
          <div class="address-item" *ngFor="let addr of addresses" (click)="selectAddress(addr.id)">
            <p><strong>{{ addr.label }}</strong></p>
            <p>{{ getAddressLabel(addr) }}</p>
          </div>
          <button class="add-address-btn" (click)="showAddNewAddress()">+ Add New Address</button>
        </div>
        <div class="add-address-form" *ngIf="showAddAddress">
          <h3>Add New Address</h3>
          <div class="form-group">
            <label>Label</label>
            <input type="text" [(ngModel)]="newAddress.label" class="form-control" placeholder="e.g., Home, Office">
          </div>
          <div class="form-group">
            <label>Address Line 1 *</label>
            <input type="text" [(ngModel)]="newAddress.line1" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Address Line 2</label>
            <input type="text" [(ngModel)]="newAddress.line2" class="form-control">
          </div>
          <div class="form-group">
            <label>City *</label>
            <input type="text" [(ngModel)]="newAddress.city" class="form-control" required>
          </div>
          <div class="form-group">
            <label>State *</label>
            <input type="text" [(ngModel)]="newAddress.state" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Postal Code *</label>
            <input type="text" [(ngModel)]="newAddress.postalCode" class="form-control" required>
          </div>
          <button class="save-btn" (click)="saveNewAddress()">Save Address</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Modal -->
  <div class="modal-overlay" *ngIf="showCancelModal" (click)="closeCancelModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Cancel Booking</h2>
        <button class="close-btn" (click)="closeCancelModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to cancel this booking?</p>
        <p class="warning">This action cannot be undone.</p>
        <div class="form-group">
          <label>Reason (optional)</label>
          <textarea [(ngModel)]="cancelReason" class="form-control" rows="3" placeholder="Tell us why you're cancelling..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="secondary-btn" (click)="closeCancelModal()">Keep Booking</button>
          <button class="danger-btn" (click)="confirmCancel()" [disabled]="cancelling">
            {{ cancelling ? 'Cancelling...' : 'Confirm Cancellation' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="modal-overlay" *ngIf="showPaymentModal" (click)="closePaymentModal()">
    <div class="modal-content payment-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Payment</h2>
        <button class="close-btn" (click)="closePaymentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="payment-tabs">
          <button [class.active]="paymentTab === 'CARD'" (click)="paymentTab = 'CARD'">Card Payment</button>
          <button [class.active]="paymentTab === 'UPI'" (click)="paymentTab = 'UPI'">UPI Payment</button>
          <button [class.active]="paymentTab === 'NET_BANKING'" (click)="paymentTab = 'NET_BANKING'">Net Banking</button>
        </div>

        <div class="payment-form" *ngIf="paymentTab === 'CARD'">
          <div class="form-group">
            <label>Card Number</label>
            <input type="text" [(ngModel)]="card.cardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19">
          </div>
          <div class="form-group">
            <label>Cardholder Name</label>
            <input type="text" [(ngModel)]="card.cardholderName" class="form-control" placeholder="John Doe">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Expiry (MM/YY)</label>
              <input type="text" [(ngModel)]="card.expiry" class="form-control" placeholder="MM/YY" maxlength="5">
            </div>
            <div class="form-group">
              <label>CVV</label>
              <input type="text" [(ngModel)]="card.cvv" class="form-control" placeholder="123" maxlength="3">
            </div>
          </div>
        </div>

        <div class="payment-form" *ngIf="paymentTab === 'UPI'">
          <div class="form-group">
            <label>UPI ID</label>
            <input type="text" [(ngModel)]="upi.upiId" class="form-control" placeholder="yourname@upi">
          </div>
        </div>

        <div class="payment-form" *ngIf="paymentTab === 'NET_BANKING'">
          <p>Net Banking - Select your bank and proceed with payment</p>
        </div>

        <div class="payment-summary">
          <div class="amount-row">
            <span>Amount to Pay:</span>
            <span class="amount">₹{{ amountToPay }}</span>
          </div>
        </div>

        <button class="pay-btn" (click)="processPayment()" [disabled]="paying">
          {{ paying ? 'Processing...' : 'Pay ₹' + amountToPay }}
        </button>
      </div>
    </div>
  </div>
</div>
